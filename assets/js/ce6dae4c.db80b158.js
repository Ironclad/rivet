"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[7047],{6593:(e,t,o)=>{o.d(t,{Zo:()=>h,kt:()=>m});var n=o(1644);function a(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function l(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?r(Object(o),!0).forEach((function(t){a(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function i(e,t){if(null==e)return{};var o,n,a=function(e,t){if(null==e)return{};var o,n,a={},r=Object.keys(e);for(n=0;n<r.length;n++)o=r[n],t.indexOf(o)>=0||(a[o]=e[o]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)o=r[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(a[o]=e[o])}return a}var s=n.createContext({}),p=function(e){var t=n.useContext(s),o=t;return e&&(o="function"==typeof e?e(t):l(l({},t),e)),o},h=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var o=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,h=i(e,["components","mdxType","originalType","parentName"]),u=p(o),d=a,m=u["".concat(s,".").concat(d)]||u[d]||c[d]||r;return o?n.createElement(m,l(l({ref:t},h),{},{components:o})):n.createElement(m,l({ref:t},h))}));function m(e,t){var o=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=o.length,l=new Array(r);l[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[u]="string"==typeof e?e:a,l[1]=i;for(var p=2;p<r;p++)l[p]=o[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,o)}d.displayName="MDXCreateElement"},4112:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>c,frontMatter:()=>r,metadata:()=>i,toc:()=>p});var n=o(373),a=(o(1644),o(6593));const r={},l="Loops",i={unversionedId:"user-guide/loops",id:"user-guide/loops",title:"Loops",description:"Loops and the loop controller are the most difficult concept in Rivet. They are also incredibly powerful and necessary for many use cases.",source:"@site/docs/user-guide/loops.md",sourceDirName:"user-guide",slug:"/user-guide/loops",permalink:"/docs/user-guide/loops",draft:!1,editUrl:"https://github.com/ironclad/rivet/tree/main/packages/docs/docs/user-guide/loops.md",tags:[],version:"current",frontMatter:{},sidebar:"userGuide",previous:{title:"Control Flow",permalink:"/docs/user-guide/control-flow"}},s={},p=[{value:"Loop Controller",id:"loop-controller",level:2},{value:"Inputs",id:"inputs",level:3},{value:"Outputs",id:"outputs",level:3},{value:"Example",id:"example",level:3},{value:"Recipes",id:"recipes",level:2},{value:"Appending to a list",id:"appending-to-a-list",level:3},{value:"Chatbot",id:"chatbot",level:3}],h={toc:p},u="wrapper";function c(e){let{components:t,...r}=e;return(0,a.kt)(u,(0,n.Z)({},h,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"loops"},"Loops"),(0,a.kt)("p",null,"Loops and the loop controller are the most difficult concept in Rivet. They are also incredibly powerful and necessary for many use cases."),(0,a.kt)("p",null,"The following is the simplest loop you can create in Rivet:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Simplest Loop",src:o(4282).Z,width:"1290",height:"488"})),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},'The node connected to Break is required at the moment. This gives the graph a "start point" to work backwards from. For basic cases, just connect a Graph Output node to ',(0,a.kt)("inlineCode",{parentName:"p"},"Break"),".")),(0,a.kt)("h2",{id:"loop-controller"},"Loop Controller"),(0,a.kt)("p",null,"The loop controller is the only node in Rivet that is allowed to contain cycles of nodes including itself. The idea is the values flow ",(0,a.kt)("em",{parentName:"p"},"through")," the loop controller in a cycle. ",(0,a.kt)("strong",{parentName:"p"},"All")," values that can change in a loop ",(0,a.kt)("strong",{parentName:"p"},"must")," flow through the loop controller itself."),(0,a.kt)("h3",{id:"inputs"},"Inputs"),(0,a.kt)("p",null,"The loop controller has one input ",(0,a.kt)("inlineCode",{parentName:"p"},"Continue")," that will always be present. This is a ",(0,a.kt)("inlineCode",{parentName:"p"},"boolean")," type (but the value passed into it will be coerced into a boolean)."),(0,a.kt)("p",null,"If the value passed into ",(0,a.kt)("inlineCode",{parentName:"p"},"Continue")," is truthy (or ",(0,a.kt)("inlineCode",{parentName:"p"},"control-flow-excluded"),"! See ",(0,a.kt)("a",{parentName:"p",href:"/docs/user-guide/control-flow"},"Control Flow"),"), then the loop will continue executing. If the value is falsy, then the loop will stop executing."),(0,a.kt)("p",null,"Next, the loop controller has a dynamic number of ",(0,a.kt)("em",{parentName:"p"},"pairs")," of values. Each pair consists of an ",(0,a.kt)("strong",{parentName:"p"},"input")," and a ",(0,a.kt)("strong",{parentName:"p"},"default input"),"."),(0,a.kt)("p",null,"The ",(0,a.kt)("strong",{parentName:"p"},"default input")," (the 2nd in each pair!) is optional. This is the default value passed through the loop controller. In most cases, you will pass values from ",(0,a.kt)("em",{parentName:"p"},"outside the loop controller"),' into the default inputs of the loop controller. These function as the "initial state" of your loops.'),(0,a.kt)("p",null,"Therefore, values for the ",(0,a.kt)("strong",{parentName:"p"},"input")," ports (the 1st in each pair!) should come from ",(0,a.kt)("em",{parentName:"p"},"inside")," the loop (nodes that are connected to the loop controller's output ports)."),(0,a.kt)("h3",{id:"outputs"},"Outputs"),(0,a.kt)("p",null,"For each pair of inputs to the loop controller (excluding the ",(0,a.kt)("inlineCode",{parentName:"p"},"Continue")," port), the loop controller will have one additional output port."),(0,a.kt)("p",null,"On the first iteration, the value of this port will be the value passed into the ",(0,a.kt)("strong",{parentName:"p"},"default value")," port of the loop controller. On subsequent iterations, the value of this port will be the value passed into the ",(0,a.kt)("strong",{parentName:"p"},"input")," port of the loop controller on the previous iteration."),(0,a.kt)("h3",{id:"example"},"Example"),(0,a.kt)("p",null,"The following image shows a loop controller with two values flowing through it. The initial values are ",(0,a.kt)("inlineCode",{parentName:"p"},"A")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"B"),":"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Loop controller iteration 1",src:o(2592).Z,width:"982",height:"570"})),(0,a.kt)("p",null,"The default values of ",(0,a.kt)("inlineCode",{parentName:"p"},"A")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"B")," flow through the loop controller to the first and 2nd outputs on the loop controller. These values flow into two text nodes, one that appends ",(0,a.kt)("inlineCode",{parentName:"p"},"+ A"),", and one that appends ",(0,a.kt)("inlineCode",{parentName:"p"},"+ B"),". These then flow back into the corresponding input ports of the loop controller."),(0,a.kt)("p",null,"On the 2nd iteration, the default values can be ignored, and the flow looks like this:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Loop controller iteration 2",src:o(5404).Z,width:"982",height:"570"})),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"A + A")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"B + B")," values flow to the output ports of the loop controller, and back into the text nodes to append ",(0,a.kt)("inlineCode",{parentName:"p"},"+ A")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"+ B")," again, flowing back into the loop controller again."),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"This loop will never break. If you were to run this graph, it would error once the loop controller reached its max iteration count.")),(0,a.kt)("h2",{id:"recipes"},"Recipes"),(0,a.kt)("h3",{id:"appending-to-a-list"},"Appending to a list"),(0,a.kt)("p",null,"A common use-case is to keep appending to some sort of array during a loop. As the ",(0,a.kt)("a",{parentName:"p",href:"/docs/node-reference/array"},"Array Node"),' is set to Flatten by default, this is easily accomplished by using an array node to concatenate the "current" value of the array with any additional values.'),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Loop array recipe",src:o(1759).Z,width:"1114",height:"417"})),(0,a.kt)("h3",{id:"chatbot"},"Chatbot"),(0,a.kt)("p",null,"Let's say you want to make a ChatGPT style chatbot in Rivet. A graph of that would look something like this:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Chatbot graph",src:o(4485).Z,width:"1972",height:"778"})),(0,a.kt)("p",null,"The loop maintains two pieces of state."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"The entire chat history minus the last chatbot message"),(0,a.kt)("li",{parentName:"ol"},"The last message from the chatbot")),(0,a.kt)("p",null,"The flow is roughly as follows:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},'The initial message from the AI is passed into the default value of the 2nd input pair. This "seeds" the graph with the initial question to present to the user.'),(0,a.kt)("li",{parentName:"ol"},"This value (the 2nd output port after ",(0,a.kt)("inlineCode",{parentName:"li"},"Break"),") is passed into a ",(0,a.kt)("a",{parentName:"li",href:"/docs/node-reference/user-input"},"User Input Node"),". This prompts the user with the last message that the chatbot sent."),(0,a.kt)("li",{parentName:"ol"},"A full message history is constructed, consisting of:",(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},"The previous full message history"),(0,a.kt)("li",{parentName:"ol"},"The last message from the chatbot"),(0,a.kt)("li",{parentName:"ol"},"The response from the user"))),(0,a.kt)("li",{parentName:"ol"},"This full message history is passed into a ",(0,a.kt)("a",{parentName:"li",href:"/docs/node-reference/chat"},"Chat Node"),". This node will return the next message from the chatbot.",(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},'At the same time, the constructed full message history is looped back into the loop controller to form the "full message history" for the next loop.'))),(0,a.kt)("li",{parentName:"ol"},"The Chat Node passes its response text into a ",(0,a.kt)("a",{parentName:"li",href:"/docs/node-reference/prompt"},"Prompt Node"),'. The prompt node is tagged with "Assistant" as the user, so that the chatbot can differentiate who sent each message.'),(0,a.kt)("li",{parentName:"ol"},"This chat-message response from the AI is passed into the value of the 2nd pair of the loop controller node."),(0,a.kt)("li",{parentName:"ol"},"The loop continues")),(0,a.kt)("p",null,"It can sometimes be difficult to understand the flow of a loop, and how to wire it up. The best way to understand it is to play around with it and see what happens!"))}c.isMDXComponent=!0},4485:(e,t,o)=>{o.d(t,{Z:()=>n});const n=o.p+"assets/images/chatbot-graph-af709b241a09473e341dfd0eecafd5b8.png"},1759:(e,t,o)=>{o.d(t,{Z:()=>n});const n=o.p+"assets/images/loop-array-recipe-6182b6f6c09476450a23abb0ebe34411.png"},2592:(e,t,o)=>{o.d(t,{Z:()=>n});const n=o.p+"assets/images/loop-controller-iteration-1-c79ed4302723bb8435c4875888a88b23.png"},5404:(e,t,o)=>{o.d(t,{Z:()=>n});const n=o.p+"assets/images/loop-controller-iteration-2-bca8658006b0e068a09fcd6ed014d876.png"},4282:(e,t,o)=>{o.d(t,{Z:()=>n});const n=o.p+"assets/images/simplest-loop-762b7cac58792eaf4c6241df558ec7ff.png"}}]);